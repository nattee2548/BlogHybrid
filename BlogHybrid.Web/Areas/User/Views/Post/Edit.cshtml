@model BlogHybrid.Web.Areas.User.Models.EditPostViewModel
@{
    ViewData["Title"] = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå";
}

<!-- Toast Notifications -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="toast-notification toast-success" style="display:flex">
        <i class="bi bi-check-circle-fill"></i>
        <span>@TempData["SuccessMessage"]</span>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="toast-notification toast-error" style="display:flex">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <span>@TempData["ErrorMessage"]</span>
    </div>
}
@if (TempData["WarningMessage"] != null)
{
    <div class="toast-notification toast-warning" style="display:flex">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <span>@TempData["WarningMessage"]</span>
    </div>
}

<div class="create-post-container">
    <div class="create-post-content">
        <!-- Header -->
        <div class="create-header">
            <h1><i class="bi bi-pencil-fill"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå</h1>
            <button type="button" onclick="window.history.back()" class="btn-close-page">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <!-- Form -->
        <form asp-action="Edit" asp-route-id="@Model.Id" method="post" enctype="multipart/form-data" class="create-post-form" id="editPostForm">
            @Html.AntiForgeryToken()

            <!-- Hidden fields -->
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="CurrentFeaturedImageUrl" />

            <!-- Main Form Content (Single Column) -->
            <div class="form-sections-single">

                <!-- 1. ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÇ‡∏û‡∏™‡∏ï‡πå -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="bi bi-pencil-fill"></i> ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÇ‡∏û‡∏™‡∏ï‡πå
                    </h2>
                    <div class="form-group">
                        <label asp-for="Title" class="form-label required">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÇ‡∏û‡∏™‡∏ï‡πå</label>
                        <input asp-for="Title"
                               class="form-control form-control-lg"
                               placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥... ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥... ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß..."
                               maxlength="200"
                               required />
                        <span asp-validation-for="Title" class="text-danger"></span>
                        <p class="form-help">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ñ‡∏ß‡∏£‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à ‡πÅ‡∏•‡∏∞‡∏™‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ (3-200 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)</p>
                    </div>
                </div>

                <!-- 2. ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏ä‡∏∏‡∏°‡∏ä‡∏ô -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="bi bi-folder-fill"></i> ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏ä‡∏∏‡∏°‡∏ä‡∏ô
                    </h2>
                    <p class="section-description">
                        <i class="bi bi-info-circle"></i>
                        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á
                    </p>

                    <!-- Hidden inputs -->
                    <input type="hidden" asp-for="CategoryId" id="categoryIdInput" />
                    <input type="hidden" asp-for="CommunityId" id="communityIdInput" />

                    <div class="selector-row">
                        <!-- Category Selector -->
                        <div class="selector-col">
                            <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            <button type="button" class="selector-btn" onclick="openCategoryModal()">
                                <i class="bi bi-folder"></i>
                                <span id="categoryDisplay">@ViewBag.SelectedCategoryName</span>
                                <i class="bi bi-chevron-right"></i>
                            </button>
                            <span asp-validation-for="CategoryId" class="text-danger"></span>
                        </div>

                        <!-- Community Selector -->
                        <div class="selector-col">
                            <label class="form-label">‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</label>
                            <button type="button" class="selector-btn" onclick="openCommunityModal()">
                                <i class="bi bi-people"></i>
                                <span id="communityDisplay">@ViewBag.SelectedCommunityName</span>
                                <i class="bi bi-chevron-right"></i>
                            </button>
                            <span asp-validation-for="CommunityId" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Validation Message -->
                    <div class="validation-message" id="selectionValidation" style="display: none;">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <span>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</span>
                    </div>
                </div>

                <!-- 3. ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÇ‡∏û‡∏™‡∏ï‡πå -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="bi bi-file-text-fill"></i> ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÇ‡∏û‡∏™‡∏ï‡πå
                    </h2>
                    <div class="form-group">
                        <label asp-for="Content" class="form-label required">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÇ‡∏û‡∏™‡∏ï‡πå</label>

                        <!-- Hidden textarea for form submission -->
                        <textarea asp-for="Content"
                                  id="contentTextarea"
                                  style="display: none;"></textarea>

                        <!-- Quill Rich Text Editor -->
                        <div id="quillEditorContainer"
                             data-quill-editor
                             data-textarea="contentTextarea"
                             data-min-length="10"
                             data-max-length="50000"
                             data-placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...&#13;&#13;‡πÉ‡∏ä‡πâ Toolbar ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"
                             data-upload-url="/User/Posts/api/upload-image"
                             data-upload-folder="posts/content">
                        </div>

                        <span asp-validation-for="Content" class="text-danger"></span>
                        <p class="form-help">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ | ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Rich Text ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                    </div>
                </div>

                <!-- 4. ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏¢‡πà‡∏≠ -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="bi bi-card-text"></i> ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏¢‡πà‡∏≠
                    </h2>
                    <div class="form-group">
                        <label asp-for="Excerpt" class="form-label">
                            ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏¢‡πà‡∏≠ <span class="optional-text">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</span>
                        </label>
                        <textarea asp-for="Excerpt"
                                  class="form-control form-textarea"
                                  rows="3"
                                  maxlength="500"
                                  placeholder="‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)"></textarea>
                        <span asp-validation-for="Excerpt" class="text-danger"></span>
                        <p class="form-help">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 500 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</p>
                    </div>
                </div>

                <!-- 5. ‡πÅ‡∏ó‡πá‡∏Å -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="bi bi-tags-fill"></i> ‡πÅ‡∏ó‡πá‡∏Å
                    </h2>
                    <div class="form-group">
                        <label asp-for="Tags" class="form-label">
                            ‡πÅ‡∏ó‡πá‡∏Å <span class="optional-text">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</span>
                        </label>

                        <!-- Hidden input for form submission -->
                        <input type="hidden" asp-for="Tags" id="tagsHiddenInput" />

                        <!-- Modern Tag Input Component -->
                        <div id="tagInputContainer"
                             data-tag-input
                             data-input="tagsHiddenInput"
                             data-max-tags="10"
                             data-colorful="true"
                             data-placeholder="Type and press Enter or Comma to add..."
                             data-popular-tags='["programming", "javascript", "tutorial", "react", "python", "web", "mobile", "design"]'>
                        </div>

                        <span asp-validation-for="Tags" class="text-danger"></span>
                        <p class="form-help">‡πÅ‡∏ó‡πá‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡πÅ‡∏ó‡πá‡∏Å)</p>
                    </div>
                </div>

                <!-- 6. ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="bi bi-image-fill"></i> ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
                    </h2>
                    <div class="form-group">
                        <label class="form-label">
                            ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å <span class="optional-text">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</span>
                        </label>

                        <!-- Current Image Display -->
                        @if (!string.IsNullOrEmpty(Model.FeaturedImageUrl))
                        {
                            <div class="current-image-display" id="currentImageDisplay">
                                <div class="current-image-label">
                                    <i class="bi bi-image"></i> ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                                </div>
                                <img src="@Model.FeaturedImageUrl" alt="Current featured image" class="current-image-preview" />
                                <button type="button" class="btn-remove-current" onclick="removeCurrentImage()">
                                    <i class="bi bi-trash"></i> ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                                </button>
                            </div>
                        }

                        <!-- File Input -->
                        <input type="file"
                               name="FeaturedImageFile"
                               id="featuredImageFileInput"
                               class="file-input-hidden"
                               accept="image/*"
                               onchange="previewNewImage(event)" />

                        <label for="featuredImageFileInput" class="file-upload-label">
                            <div class="file-upload-icon">
                                <i class="bi bi-cloud-upload"></i>
                            </div>
                            <div class="file-upload-text">
                                <span class="file-upload-title">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà</span>
                                <span class="file-upload-hint">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á</span>
                                <span class="file-upload-format">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG, GIF, WebP | ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB</span>
                            </div>
                        </label>

                        <!-- New Image Preview -->
                        <div id="newImagePreview" style="display: none;" class="image-preview">
                            <div class="image-preview-label">
                                <i class="bi bi-image"></i> ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                            </div>
                            <img id="newPreviewImage" src="" alt="New preview" />
                            <button type="button" class="btn-remove-preview" onclick="removeNewImage()">
                                <i class="bi bi-x-circle"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>

                        <!-- Hidden field ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö URL (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) -->
                        <input type="hidden" asp-for="FeaturedImageUrl" id="featuredImageUrlInput" />

                        <p class="form-help">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1200x630 ‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏• ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏ö‡∏ô Social Media</p>
                    </div>
                </div>

                <!-- 7. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏û‡∏™‡∏ï‡πå -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="bi bi-gear-fill"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏û‡∏™‡∏ï‡πå
                    </h2>

                    <div class="form-check-group">
                        <div class="form-check">
                            <input asp-for="IsPublished"
                                   class="form-check-input"
                                   type="checkbox"
                                   id="isPublished" />
                            <label class="form-check-label" for="isPublished">
                                <i class="bi bi-eye-fill"></i> ‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                            </label>
                        </div>

                        <div class="form-check">
                            <input asp-for="IsFeatured"
                                   class="form-check-input"
                                   type="checkbox"
                                   id="isFeatured" />
                            <label class="form-check-label" for="isFeatured">
                                <i class="bi bi-star-fill"></i> ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 8. ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ -->
                <div class="form-actions-bottom">
                    <button type="submit" class="btn btn-primary btn-create" id="submitBtn">
                        <span class="btn-text">
                            <i class="bi bi-check-circle-fill"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </span>
                        <span class="btn-spinner" style="display: none;">
                            <span class="spinner"></span>
                            <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>
                        </span>
                    </button>
                    <button type="button" onclick="window.history.back()" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>

            </div>
        </form>
    </div>
</div>

<!-- Category Selection Modal -->
<div class="selector-modal" id="categoryModal">
    <div class="selector-modal-overlay" onclick="closeCategoryModal()"></div>
    <div class="selector-modal-content">
        <div class="selector-modal-header">
            <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
            <button type="button" class="selector-modal-close" onclick="closeCategoryModal()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="selector-modal-body">
            <!-- Search Box -->
            <div class="selector-search">
                <i class="bi bi-search"></i>
                <input type="text"
                       id="categorySearchInput"
                       placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà..."
                       oninput="searchCategories(this.value)" />
                <button type="button" onclick="clearCategorySearch()" class="search-clear">
                    <i class="bi bi-x"></i>
                </button>
            </div>

            <!-- Categories List -->
            <div class="selector-list" id="categoryList">
                @if (ViewBag.Categories != null)
                {
                    void RenderCategories(dynamic categories, int level = 0)
                    {
                        foreach (var category in categories)
                        {
                            var isParent = category.SubCategories != null && category.SubCategories.Count > 0;
                            var cssClass = isParent ? "parent" : (level > 0 ? "child" : "");

                            <div class="selector-group">
                                <button type="button"
                                        class="selector-item @cssClass @(Model.CategoryId == category.Id ? "selected" : "")"
                                        data-id="@category.Id"
                                        data-name="@category.Name"
                                        onclick="selectCategory(@category.Id, '@category.Name')">
                                    <div class="selector-item-icon" style="background: @(category.Color ?? "#ff4500")">
                                        <i class="bi bi-folder@(isParent ? "-fill" : "")"></i>
                                    </div>
                                    <span>@category.Name</span>
                                    <i class="bi bi-check-circle-fill selector-check"></i>
                                </button>

                                @if (isParent)
                                {
                                    <div class="selector-children">
                                        @{
                                            RenderCategories(category.SubCategories, level + 1);
                                        }
                                    </div>
                                }
                            </div>
                        }
                    }

                    RenderCategories(ViewBag.Categories);
                }
            </div>
        </div>
    </div>
</div>

<!-- Community Selection Modal -->
<div class="selector-modal" id="communityModal">
    <div class="selector-modal-overlay" onclick="closeCommunityModal()"></div>
    <div class="selector-modal-content">
        <div class="selector-modal-header">
            <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</h3>
            <button type="button" class="selector-modal-close" onclick="closeCommunityModal()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="selector-modal-body">
            <!-- Search Box -->
            <div class="selector-search">
                <i class="bi bi-search"></i>
                <input type="text"
                       id="communitySearch"
                       placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∏‡∏°‡∏ä‡∏ô..." />
            </div>

            <!-- Communities List -->
            <div class="selector-list" id="communitiesList">
                @if (ViewBag.Communities != null)
                {
                    foreach (var community in ViewBag.Communities)
                    {
                        <button type="button"
                                class="selector-item @(Model.CommunityId == community.Id ? "selected" : "")"
                                data-id="@community.Id"
                                data-name="@community.Name"
                                onclick="selectCommunity(@community.Id, '@community.Name')">
                            @if (!string.IsNullOrEmpty(community.ImageUrl))
                            {
                                <img src="@community.ImageUrl" alt="@community.Name" class="selector-item-avatar" />
                            }
                            else
                            {
                                <div class="selector-item-icon">
                                    <i class="bi bi-people-fill"></i>
                                </div>
                            }
                            <div class="selector-item-content">
                                <span class="selector-item-name">
                                    @community.Name
                                    @if (community.IsPrivate)
                                    {
                                        <i class="bi bi-lock-fill" style="font-size: 0.75rem; opacity: 0.6;"></i>
                                    }
                                </span>
                                <span class="selector-item-meta">@community.MemberCount ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
                            </div>
                            <i class="bi bi-check-circle-fill selector-check"></i>
                        </button>
                    }
                }
            </div>
        </div>
    </div>
</div>

@section Styles {
    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="~/css/post-create.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/tag-input.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/quill-editor.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/loading-spinner.css" asp-append-version="true" />
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <!-- Custom Scripts -->
    <script src="~/js/quill-editor.js" asp-append-version="true"></script>
    <script src="~/js/tag-input.js" asp-append-version="true"></script>
    <script src="~/js/post-create.js" asp-append-version="true"></script>

    <script>
        // ===================================
        // Category Search Functions
        // ===================================
        function searchCategories(searchTerm) {
            searchTerm = searchTerm.toLowerCase();
            const items = document.querySelectorAll('#categoryList .selector-item');

            items.forEach(item => {
                const name = item.dataset.name.toLowerCase();
                item.style.display = name.includes(searchTerm) ? '' : 'none';
            });

            // Show/hide groups
            document.querySelectorAll('#categoryList .selector-group').forEach(group => {
                const visibleItems = group.querySelectorAll('.selector-item:not([style*="display: none"])');
                group.style.display = visibleItems.length > 0 ? '' : 'none';
            });
        }

        function clearCategorySearch() {
            const searchInput = document.getElementById('categorySearchInput');
            if (searchInput) {
                searchInput.value = '';
                searchCategories('');
            }
        }

        // ===================================
        // Community Search Functions
        // ===================================
        function searchCommunities(searchTerm) {
            searchTerm = searchTerm.toLowerCase();
            const items = document.querySelectorAll('#communitiesList .selector-item');

            items.forEach(item => {
                const name = item.dataset.name.toLowerCase();
                item.style.display = name.includes(searchTerm) ? '' : 'none';
            });
        }

        function clearCommunitySearch() {
            const searchInput = document.getElementById('communitySearch');
            if (searchInput) {
                searchInput.value = '';
                searchCommunities('');
            }
        }

        // ===================================
        // Load Existing Data on Page Load
        // ===================================
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-hide toast after 5 seconds
            setTimeout(() => {
                document.querySelectorAll(".toast-notification").forEach(t => t.style.display = "none");
            }, 5000);

            console.log('üîÑ Loading existing post data...');

            // 1. Load Content into Quill Editor
            @if (!string.IsNullOrEmpty(Model.Content))
            {
                    <text>
                    setTimeout(() => {
                        if (window.quillEditor) {
                            console.log('‚úÖ Loading content into Quill');
                            window.quillEditor.root.innerHTML = `@Html.Raw(Model.Content)`;
                        }
                    }, 100);
                    </text>
            }

            // 2. Load Tags
            @if (!string.IsNullOrEmpty(Model.Tags))
            {
                    <text>
                    const loadTags = () => {
                        const tagInputContainer = document.querySelector('[data-tag-input]');
                        if (tagInputContainer && tagInputContainer._tagInputInstance) {
                            console.log('‚úÖ Loading tags');
                            const existingTags = '@Model.Tags'.split(',');
                            existingTags.forEach(tag => {
                                const trimmedTag = tag.trim();
                                if (trimmedTag) {
                                    tagInputContainer._tagInputInstance.addTag(trimmedTag, false);
                                }
                            });
                            return true;
                        }
                        return false;
                    };

                    if (!loadTags()) {
                        setTimeout(loadTags, 100);
                    }
                    </text>
            }

            // 3. Load Featured Image Preview
            @if (!string.IsNullOrEmpty(Model.FeaturedImageUrl))
            {
                    <text>
                    setTimeout(() => {
                        const featuredImageUrlInput = document.getElementById('featuredImageUrlInput');
                        if (featuredImageUrlInput && featuredImageUrlInput.value) {
                            console.log('‚úÖ Setting featured image');
                        }
                    }, 100);
                    </text>
            }

            // Scroll to top
            setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'instant' });
            }, 150);

            console.log('‚úÖ Existing data loaded');
        });

        // ===================================
        // Category Modal Functions
        // ===================================
        function openCategoryModal() {
            document.getElementById('categoryModal').classList.add('active');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
        }

        function selectCategory(id, name) {
            document.getElementById('categoryIdInput').value = id;
            document.getElementById('categoryDisplay').textContent = name;

            // Remove selected class from all items
            document.querySelectorAll('#categoryList .selector-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Add selected class to clicked item
            event.target.closest('.selector-item').classList.add('selected');

            closeCategoryModal();
        }

        // Category Search
        document.getElementById('categorySearchInput')?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const items = document.querySelectorAll('#categoryList .selector-item');

            items.forEach(item => {
                const name = item.dataset.name.toLowerCase();
                item.style.display = name.includes(searchTerm) ? '' : 'none';
            });
        });

        // ===================================
        // Community Modal Functions
        // ===================================
        function openCommunityModal() {
            document.getElementById('communityModal').classList.add('active');
        }

        function closeCommunityModal() {
            document.getElementById('communityModal').classList.remove('active');
        }

        function selectCommunity(id, name) {
            document.getElementById('communityIdInput').value = id;
            document.getElementById('communityDisplay').textContent = name;

            // Remove selected class from all items
            document.querySelectorAll('#communitiesList .selector-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Add selected class to clicked item
            event.target.closest('.selector-item').classList.add('selected');

            closeCommunityModal();
        }

        // Community Search
        document.getElementById('communitySearch')?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const items = document.querySelectorAll('#communitiesList .selector-item');

            items.forEach(item => {
                const name = item.dataset.name.toLowerCase();
                item.style.display = name.includes(searchTerm) ? '' : 'none';
            });
        });

        // ===================================
        // Image Upload & Preview Functions
        // ===================================
        function removeCurrentImage() {
            document.getElementById('currentImageDisplay').style.display = 'none';
            document.getElementById('featuredImageUrlInput').value = '';
        }

        function previewNewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('newPreviewImage').src = e.target.result;
                    document.getElementById('newImagePreview').style.display = 'block';
                    // ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                    const currentDisplay = document.getElementById('currentImageDisplay');
                    if (currentDisplay) {
                        currentDisplay.style.display = 'none';
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function removeNewImage() {
            document.getElementById('featuredImageFileInput').value = '';
            document.getElementById('newImagePreview').style.display = 'none';
            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
            const currentDisplay = document.getElementById('currentImageDisplay');
            if (currentDisplay) {
                currentDisplay.style.display = 'block';
            }
        }

        // Close modals on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCategoryModal();
                closeCommunityModal();
            }
        });
    </script>
}