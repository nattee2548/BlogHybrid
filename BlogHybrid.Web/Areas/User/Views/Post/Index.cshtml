@model BlogHybrid.Web.Areas.User.Models.MyPostsViewModel
@{
    ViewData["Title"] = "โพสต์ของฉัน";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/user/my-posts.css" asp-append-version="true" />
}

<div class="main-container" style="padding: 80px 0 40px;">
    <div class="container" style="max-width: 1400px;">

        <!-- User Navigation Tabs -->
        <div class="user-nav-tabs">
            <a asp-area="User" asp-controller="Profile" asp-action="Index" class="user-nav-tab">
                <i class="bi bi-person"></i> โปรไฟล์
            </a>
            <a asp-area="User" asp-controller="Posts" asp-action="Index" class="user-nav-tab active">
                <i class="bi bi-file-earmark-text"></i> โพสต์ของฉัน
            </a>
            <a asp-area="User" asp-controller="Communities" asp-action="Index" class="user-nav-tab">
                <i class="bi bi-people"></i> ชุมชนของฉัน
            </a>
            <a asp-area="User" asp-controller="Profile" asp-action="Edit" class="user-nav-tab">
                <i class="bi bi-gear"></i> ตั้งค่า
            </a>
        </div>

        <!-- Header & Statistics -->
        <div class="my-posts-header">
            <div class="header-top">
                <div class="header-title">
                    <h1>
                        <i class="bi bi-file-earmark-text"></i>
                        โพสต์ของฉัน
                    </h1>
                    <p>จัดการโพสต์ทั้งหมดของคุณ</p>
                </div>
                <a asp-area="User" asp-controller="Posts" asp-action="Create" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> สร้างโพสต์ใหม่
                </a>
            </div>

            <!-- Statistics Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon stat-icon-primary">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@Model.TotalCount</div>
                        <div class="stat-label">โพสต์ทั้งหมด</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon stat-icon-success">
                        <i class="bi bi-eye"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@Model.Statistics.PublishedCount</div>
                        <div class="stat-label">เผยแพร่แล้ว</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon stat-icon-secondary">
                        <i class="bi bi-file-earmark"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@Model.Statistics.DraftCount</div>
                        <div class="stat-label">แบบร่าง</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon stat-icon-warning">
                        <i class="bi bi-star"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@Model.Statistics.FeaturedCount</div>
                        <div class="stat-label">โพสต์แนะนำ</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon stat-icon-info">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@Model.Statistics.TotalViews.ToString("N0")</div>
                        <div class="stat-label">ยอดดูทั้งหมด</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon stat-icon-danger">
                        <i class="bi bi-heart"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">@Model.Statistics.TotalLikes.ToString("N0")</div>
                        <div class="stat-label">ยอดไลค์ทั้งหมด</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toolbar: Filters, View Toggle & Search -->
        <div class="posts-toolbar">
            <div class="toolbar-left">
                <div class="filter-group">
                    <label>สถานะ:</label>
                    <div class="filter-buttons">
                        <a href="?status=all&search=@Model.SearchTerm" 
                           class="filter-btn @(Model.StatusFilter == "all" ? "active" : "")">
                            ทั้งหมด (@Model.TotalCount)
                        </a>
                        <a href="?status=published&search=@Model.SearchTerm" 
                           class="filter-btn @(Model.StatusFilter == "published" ? "active" : "")">
                            เผยแพร่ (@Model.Statistics.PublishedCount)
                        </a>
                        <a href="?status=draft&search=@Model.SearchTerm" 
                           class="filter-btn @(Model.StatusFilter == "draft" ? "active" : "")">
                            แบบร่าง (@Model.Statistics.DraftCount)
                        </a>
                        <a href="?status=featured&search=@Model.SearchTerm" 
                           class="filter-btn @(Model.StatusFilter == "featured" ? "active" : "")">
                            แนะนำ (@Model.Statistics.FeaturedCount)
                        </a>
                    </div>
                </div>
            </div>

            <div class="toolbar-right">
                <!-- ✅ View Toggle (Default = List) -->
                <div class="view-toggle">
                    <button type="button" class="view-toggle-btn" data-view="grid" title="แสดงแบบการ์ด">
                        <i class="bi bi-grid-3x3-gap-fill"></i>
                    </button>
                    <button type="button" class="view-toggle-btn active" data-view="list" title="แสดงแบบรายการ">
                        <i class="bi bi-list-ul"></i>
                    </button>
                </div>

                <!-- Search Form -->
                <form method="get" class="search-form">
                    <input type="hidden" name="status" value="@Model.StatusFilter" />
                    <input type="text" 
                           name="search" 
                           value="@Model.SearchTerm" 
                           placeholder="ค้นหาโพสต์..." 
                           class="search-input" />
                    <button type="submit" class="search-btn">
                        <i class="bi bi-search"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- Posts Container (Default = List View) -->
        @if (Model.Posts.Any())
        {
            <div class="my-posts-container" data-view="list">
                @foreach (var post in Model.Posts)
                {
                    <div class="post-item">
                        <!-- Image -->
                        <div class="post-item-image">
                            @if (!string.IsNullOrEmpty(post.FeaturedImageUrl))
                            {
                                <img src="@post.FeaturedImageUrl" alt="@post.Title" />
                            }
                            else
                            {
                                <div class="post-image-placeholder">
                                    <i class="bi bi-image"></i>
                                </div>
                            }
                            
                            <!-- Status Badge on Image -->
                            @if (post.IsFeatured)
                            {
                                <span class="featured-badge-small">
                                    <i class="bi bi-star-fill"></i>
                                </span>
                            }
                        </div>

                        <!-- Content -->
                        <div class="post-item-content">
                            <!-- Title & Meta Row -->
                            <div class="post-item-header">
                                <div class="post-item-title-group">
                                    <h3 class="post-item-title">@post.Title</h3>
                                    
                                    <!-- Badges -->
                                    <div class="post-item-badges">
                                        @if (!string.IsNullOrEmpty(post.CategoryName))
                                        {
                                            <span class="badge badge-category">
                                                <i class="bi bi-folder"></i> @post.CategoryName
                                            </span>
                                        }
                                        @if (!string.IsNullOrEmpty(post.CommunityName))
                                        {
                                            <span class="badge badge-community">
                                                <i class="bi bi-people"></i> @post.CommunityName
                                            </span>
                                        }
                                        <span class="badge @(post.IsPublished ? "badge-published" : "badge-draft")">
                                            @if (post.IsPublished)
                                            {
                                                <i class="bi bi-eye"></i>
                                                <span>เผยแพร่</span>
                                            }
                                            else
                                            {
                                                <i class="bi bi-file-earmark"></i>
                                                <span>แบบร่าง</span>
                                            }
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Date -->
                                <div class="post-item-date">
                                    <i class="bi bi-calendar"></i>
                                    @post.CreatedAt.ToString("dd MMM yyyy")
                                </div>
                            </div>

                            <!-- Excerpt -->
                            @if (!string.IsNullOrEmpty(post.Excerpt))
                            {
                                <p class="post-item-excerpt">@post.Excerpt</p>
                            }

                            <!-- Tags -->
                            @if (post.Tags.Any())
                            {
                                <div class="post-item-tags">
                                    @foreach (var tag in post.Tags.Take(5))
                                    {
                                        <span class="tag-small">
                                            <i class="bi bi-tag"></i> @tag
                                        </span>
                                    }
                                    @if (post.Tags.Count > 5)
                                    {
                                        <span class="tag-small">+@(post.Tags.Count - 5)</span>
                                    }
                                </div>
                            }
                        </div>

                        <!-- Stats -->
                        <div class="post-item-stats">
                            <span class="stat-item-small">
                                <i class="bi bi-eye"></i>
                                <span>@post.ViewCount.ToString("N0")</span>
                            </span>
                            <span class="stat-item-small">
                                <i class="bi bi-heart"></i>
                                <span>@post.LikeCount.ToString("N0")</span>
                            </span>
                            <span class="stat-item-small">
                                <i class="bi bi-chat"></i>
                                <span>@post.CommentCount.ToString("N0")</span>
                            </span>
                        </div>

                        <!-- Actions -->
                        <div class="post-item-actions">
                            <a asp-area="User" 
                               asp-controller="Post" 
                               asp-action="Edit" 
                               asp-route-id="@post.Id" 
                               class="btn-action-small btn-edit" 
                               title="แก้ไข">
                                <i class="bi bi-pencil-fill"></i>
                            </a>
                            <a asp-area="" 
                               asp-controller="Post" 
                               asp-action="Details" 
                               asp-route-slug="@post.Slug" 
                               class="btn-action-small btn-view" 
                               title="ดู" 
                               target="_blank">
                                <i class="bi bi-eye-fill"></i>
                            </a>
                            <button type="button" 
                                    class="btn-action-small btn-delete" 
                                    onclick="confirmDelete(@post.Id, '@Html.Raw(post.Title.Replace("'", "\\'"))')" 
                                    title="ลบ">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    </div>
                }
            </div>

            <!-- Pagination -->
            @if (Model.TotalPages > 1)
            {
                <nav class="pagination-container">
                    <ul class="pagination">
                        <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
                            <a class="page-link" 
                               href="?page=@(Model.PageNumber - 1)&search=@Model.SearchTerm&status=@Model.StatusFilter">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>

                        @for (int i = 1; i <= Model.TotalPages; i++)
                        {
                            <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                <a class="page-link" 
                                   href="?page=@i&search=@Model.SearchTerm&status=@Model.StatusFilter">
                                    @i
                                </a>
                            </li>
                        }

                        <li class="page-item @(Model.HasNextPage ? "" : "disabled")">
                            <a class="page-link" 
                               href="?page=@(Model.PageNumber + 1)&search=@Model.SearchTerm&status=@Model.StatusFilter">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            }
        }
        else
        {
            <!-- Empty State -->
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="bi bi-inbox"></i>
                </div>
                <h3>ไม่พบโพสต์</h3>
                @if (!string.IsNullOrEmpty(Model.SearchTerm) || Model.StatusFilter != "all")
                {
                    <p>ไม่พบโพสต์ที่ตรงกับเงื่อนไขการค้นหา</p>
                    <a href="?" class="btn btn-secondary">
                        <i class="bi bi-arrow-counterclockwise"></i> แสดงทั้งหมด
                    </a>
                }
                else
                {
                    <p>คุณยังไม่มีโพสต์ เริ่มสร้างโพสต์แรกของคุณเลย!</p>
                    <a asp-area="User" asp-controller="Posts" asp-action="Create" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> สร้างโพสต์ใหม่
                    </a>
                }
            </div>
        }

    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <h3><i class="bi bi-exclamation-triangle"></i> ยืนยันการลบ</h3>
        <p>คุณแน่ใจหรือไม่ว่าต้องการลบโพสต์ <strong id="postTitle"></strong>?</p>
        <p class="text-danger">การกระทำนี้ไม่สามารถย้อนกลับได้</p>
        <form id="deleteForm" method="post" asp-area="User" asp-controller="Posts" asp-action="Delete">
            @Html.AntiForgeryToken()
            <input type="hidden" name="id" id="postId" />
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">
                    <i class="bi bi-x"></i> ยกเลิก
                </button>
                <button type="submit" class="btn btn-danger">
                    <i class="bi bi-trash"></i> ลบโพสต์
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="~/js/user/my-posts.js" asp-append-version="true"></script>
}
