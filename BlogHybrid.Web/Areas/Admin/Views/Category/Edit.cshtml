@* BlogHybrid.Web/Areas/Admin/Views/Category/Edit.cshtml - Simple Version *@
@model BlogHybrid.Web.Models.ViewModels.Admin.EditCategoryViewModel
@{
    ViewData["Title"] = "แก้ไขหมวดหมู่: " + Model.Name;
    Layout = "_AdminLayout";
}

<div class="admin-page-header">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1 admin-text-primary">
                <i class="fas fa-edit me-2"></i>แก้ไขหมวดหมู่
            </h1>
            <p class="admin-text-secondary mb-0">แก้ไขข้อมูลหมวดหมู่: <strong>@Model.Name</strong></p>
        </div>
        <div class="d-flex gap-2">
            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>กลับไปรายการ
            </a>
        </div>
    </div>
</div>

@if (Model.HasPosts)
{
    <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle me-2"></i>
        หมวดหมู่นี้มีบทความ <strong>@Model.PostCount รายการ</strong> การเปลี่ยนแปลงจะส่งผลต่อบทความทั้งหมด
    </div>
}

<form asp-action="Edit" method="post" class="admin-form" novalidate>
    @Html.AntiForgeryToken()
    <input asp-for="Id" type="hidden">

    <div class="row">
        <div class="col-lg-8">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>ข้อมูลหมวดหมู่</h5>
                </div>
                <div class="admin-card-body">
                    <div class="mb-3">
                        <label for="Name" class="form-label required">ชื่อหมวดหมู่</label>
                        <input name="Name" id="Name" class="form-control" placeholder="เช่น Career Talk, Life Advice" value="@Model.Name">
                        <span asp-validation-for="Name" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">URL Slug ปัจจุบัน</label>
                        <div class="input-group">
                            <span class="input-group-text">404talk.com/category/</span>
                            <input type="text" class="form-control" value="@Model.CurrentSlug" readonly>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="Description" class="form-label">คำอธิบาย</label>
                        <textarea name="Description" id="Description" class="form-control" rows="4">@Model.Description</textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label for="Color" class="form-label">สีประจำหมวดหมู่</label>
                        <div class="input-group">
                            <input name="Color" type="color" class="form-control form-control-color" style="width: 60px;" value="@Model.Color">
                            <input type="text" class="form-control color-text" placeholder="#0066cc" value="@Model.Color" onchange="syncColor(this)">
                        </div>
                        <span asp-validation-for="Color" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label for="SortOrder" class="form-label">ลำดับการแสดงผล</label>
                        <input name="SortOrder" id="SortOrder" type="number" class="form-control" min="0" max="999" value="@Model.SortOrder">
                        <span asp-validation-for="SortOrder" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input name="IsActive" type="checkbox" class="form-check-input" value="true" @(Model.IsActive ? "checked" : "")>
                            <input name="IsActive" type="hidden" value="false">
                            <label for="IsActive" class="form-check-label">เปิดใช้งานหมวดหมู่นี้</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-card-header">
                    <h5 class="mb-0"><i class="fas fa-image me-2"></i>รูปภาพประจำหมวดหมู่</h5>
                </div>
                <div class="admin-card-body">
                    <input type="hidden" name="ImageUrl" id="ImageUrl" value="@(Model.ImageUrl ?? "")" />

                    @if (!string.IsNullOrEmpty(Model.ImageUrl))
                    {
                        <div id="currentImageContainer" class="mb-3">
                            <img id="currentImage" src="@Model.ImageUrl" alt="รูปภาพปัจจุบัน" class="img-thumbnail" style="max-width: 200px;">
                            <div class="mt-2">
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeImage()">
                                    <i class="fas fa-times me-1"></i>ลบรูปภาพ
                                </button>
                            </div>
                        </div>
                    }

                    <div class="input-group">
                        <input type="file" class="form-control" id="imageFile" accept="image/*" onchange="handleImage(this)">
                        <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('imageFile').click()">
                            <i class="fas fa-upload me-1"></i>เลือกรูปภาพ
                        </button>
                    </div>
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-card-body">
                    <div class="d-flex gap-2 justify-content-end">
                        <a href="@Url.Action("Index")" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>ยกเลิก
                        </a>
                        <button type="submit" class="btn btn-primary" id="saveBtn">
                            <i class="fas fa-save me-2"></i>บันทึกการแก้ไข
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>สถิติหมวดหมู่</h6>
                </div>
                <div class="admin-card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>จำนวนบทความ:</span>
                        <strong>@Model.PostCount รายการ</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>สถานะ:</span>
                        <span class="badge @Model.StatusClass">@Model.StatusBadge</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>URL Slug:</span>
                        <code>@Model.CurrentSlug</code>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>ลำดับ:</span>
                        <strong>@Model.SortOrder</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            const btn = document.getElementById('saveBtn');

            // Debug
            console.log('Form:', form);
            console.log('Button:', btn);

            if (form) {
                form.addEventListener('submit', function(e) {
                    console.log('Form submitting!');

                    // ✅ แปลง ImageUrl จาก full URL เป็น relative path ก่อนบันทึก
                    const imageUrlField = document.getElementById('ImageUrl');
                    if (imageUrlField && imageUrlField.value) {
                        const currentUrl = imageUrlField.value;

                        // ถ้าเป็น full URL ให้แปลงเป็น relative path
                        if (currentUrl.startsWith('https://pub-')) {
                            const pathMatch = currentUrl.match(/\/categories\/(.+)$/);
                            if (pathMatch) {
                                imageUrlField.value = `categories/${pathMatch[1]}`;
                                console.log('Converted ImageUrl from:', currentUrl, 'to:', imageUrlField.value);
                            }
                        }
                    }

                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>กำลังบันทึก...';
                    }

                    // Don't prevent default - let form submit normally
                });
            }

            console.log('ImageUrl field:', document.getElementById('ImageUrl'));
            console.log('ImageUrl value:', document.getElementById('ImageUrl')?.value);
        });

        function syncColor(textInput) {
            const colorInput = textInput.parentElement.querySelector('input[type="color"]');
            if (colorInput) colorInput.value = textInput.value;
        }

        function handleImage(input) {
            const file = input.files[0];
            if (!file) return;

            // Show preview first
            const reader = new FileReader();
            reader.onload = function(e) {
                let container = document.getElementById('currentImageContainer');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'currentImageContainer';
                    container.className = 'mb-3';
                    input.parentElement.parentElement.insertBefore(container, input.parentElement);
                }

                container.innerHTML = `
                    <img id="currentImage" src="${e.target.result}" alt="รูปภาพใหม่" class="img-thumbnail" style="max-width: 200px;">
                    <div class="mt-2">
                        <span class="text-muted">กำลังอัพโหลด...</span>
                        <button type="button" class="btn btn-danger btn-sm ms-2" onclick="removeImage()">
                            <i class="fas fa-times me-1"></i>ลบรูปภาพ
                        </button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);

            // Upload with better error handling
            const formData = new FormData();
            formData.append('file', file);

            fetch('/Admin/Image/UploadCategory', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                // Check if response is ok
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    return response.text().then(text => {
                        console.log('Non-JSON response:', text);
                        throw new Error('Server returned non-JSON response: ' + text.substring(0, 100));
                    });
                }

                return response.json();
            })
            .then(result => {
                console.log('Upload result:', result);
                if (result.success) {
                    // ✅ ใช้ imagePath แทน imageUrl (เพื่อให้ตรงกับ database format)
                    document.getElementById('ImageUrl').value = result.imagePath || result.imageUrl;

                    const statusSpan = document.querySelector('#currentImageContainer .text-muted');
                    if (statusSpan) {
                        statusSpan.textContent = 'อัพโหลดสำเร็จ';
                        statusSpan.className = 'text-success';
                    }
                } else {
                    alert('เกิดข้อผิดพลาด: ' + result.message);
                    removeImage();
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
                removeImage();
            });
        }

        function removeImage() {
            const container = document.getElementById('currentImageContainer');
            if (container) container.remove();
            document.getElementById('ImageUrl').value = ''; // ✅ เปลี่ยน name
            document.getElementById('imageFile').value = '';
        }
    </script>

    <style>
        .required::after {
            content: " *";
            color: #dc2626;
        }

        .form-control-color {
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
}