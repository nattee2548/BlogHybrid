@model BlogHybrid.Web.Areas.Admin.Models.ChangeUserPasswordViewModel
@{
    ViewData["Title"] = "เปลี่ยนรหัสผ่าน Admin";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<!-- Toast Notifications -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="toast-notification toast-success">
        <i class="bi bi-check-circle-fill"></i>
        <span>@TempData["SuccessMessage"]</span>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="toast-notification toast-error">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <span>@TempData["ErrorMessage"]</span>
    </div>
}

<div class="admin-page-header">
    <div>
        <h1><i class="bi bi-key"></i> เปลี่ยนรหัสผ่าน Admin</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-action="Index">Admin</a></li>
                <li class="breadcrumb-item"><a asp-action="Details" asp-route-id="@Model.UserId">@Model.UserName</a></li>
                <li class="breadcrumb-item active">เปลี่ยนรหัสผ่าน</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Main Form Card -->
        <div class="admin-card">
            <div class="admin-card-header">
                <h5 class="mb-0">
                    <i class="bi bi-shield-lock"></i> ตั้งรหัสผ่านใหม่สำหรับ <strong>@Model.UserName</strong>
                </h5>
            </div>
            <div class="admin-card-body">
                <div class="alert alert-warning d-flex align-items-start gap-2">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>คำเตือน:</strong> การเปลี่ยนรหัสผ่านจะมีผลทันที และผู้ใช้จะถูกล็อกเอาท์จากทุก device
                </div>

                <form asp-action="ChangePassword" method="post">
                    @Html.HiddenFor(m => m.UserId)
                    @Html.HiddenFor(m => m.UserName)
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                    <div class="mb-3">
                        <label asp-for="NewPassword" class="form-label required"></label>
                        <input asp-for="NewPassword" class="form-control" autocomplete="new-password" />
                        <span asp-validation-for="NewPassword" class="text-danger"></span>
                        <small class="text-muted">รหัสผ่านต้องมีความยาวอย่างน้อย 6 ตัวอักษร</small>
                    </div>

                    <div class="mb-3">
                        <label asp-for="ConfirmPassword" class="form-label required"></label>
                        <input asp-for="ConfirmPassword" class="form-control" autocomplete="new-password" />
                        <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                    </div>

                    <hr class="my-4" />

                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-warning" onclick="confirmChangePassword()">
                            <i class="bi bi-key"></i> เปลี่ยนรหัสผ่าน
                        </button>
                        <a asp-action="Details" asp-route-id="@Model.UserId" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> ยกเลิก
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Password Strength Indicator -->
        <div class="admin-card mt-4">
            <div class="admin-card-body">
                <h6 class="mb-3"><i class="bi bi-shield-check"></i> ความแข็งแกร่งของรหัสผ่าน</h6>
                <div id="passwordStrength" class="mb-3">
                    <div class="progress" style="height: 8px;">
                        <div id="strengthBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small id="strengthText" class="text-muted">กรุณากรอกรหัสผ่าน</small>
                </div>

                <h6 class="mb-2">ข้อกำหนดรหัสผ่าน:</h6>
                <ul class="list-unstyled mb-0">
                    <li id="req-length" class="small text-muted"><i class="bi bi-circle me-1"></i> ความยาวอย่างน้อย 8 ตัวอักษร</li>
                    <li id="req-lowercase" class="small text-muted"><i class="bi bi-circle me-1"></i> มีตัวอักษรพิมพ์เล็ก (a-z)</li>
                    <li id="req-uppercase" class="small text-muted"><i class="bi bi-circle me-1"></i> มีตัวอักษรพิมพ์ใหญ่ (A-Z)</li>
                    <li id="req-number" class="small text-muted"><i class="bi bi-circle me-1"></i> มีตัวเลข (0-9)</li>
                    <li id="req-special" class="small text-muted"><i class="bi bi-circle me-1"></i> มีอักขระพิเศษ (!@@#$%^&*)</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Security Info Card -->
        <div class="admin-card">
            <div class="admin-card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> ข้อมูลความปลอดภัย</h5>
            </div>
            <div class="admin-card-body">
                <ul class="mb-0 small">
                    <li>การเปลี่ยนรหัสผ่านจะมีผลทันที</li>
                    <li>Admin นี้จะถูกล็อกเอาท์จากทุก device</li>
                    <li>จะต้อง login ใหม่ด้วยรหัสผ่านใหม่</li>
                    <li>ระบบจะบันทึก log การเปลี่ยนรหัสผ่าน</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning"></i>
                    ยืนยันการเปลี่ยนรหัสผ่าน
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">คุณแน่ใจหรือไม่ที่จะเปลี่ยนรหัสผ่านของ <strong>@Model.UserName</strong>?</p>
                <div class="alert alert-warning mb-0">
                    <small>
                        <strong>หมายเหตุ:</strong>
                        <ul class="mb-0 mt-2">
                            <li>การเปลี่ยนรหัสผ่านจะมีผลทันที</li>
                            <li>Admin นี้จะถูกล็อกเอาท์จากทุก device</li>
                            <li>จะต้อง login ใหม่ด้วยรหัสผ่านใหม่</li>
                        </ul>
                    </small>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i> ยกเลิก
                </button>
                <button type="button" class="btn btn-warning" onclick="submitPasswordChange()">
                    <i class="bi bi-key"></i> ยืนยันเปลี่ยนรหัสผ่าน
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        // Toast Auto-hide
        document.addEventListener('DOMContentLoaded', function() {
            const toasts = document.querySelectorAll('.toast-notification');
            toasts.forEach(toast => {
                setTimeout(() => {
                    toast.classList.add('toast-show');
                }, 100);

                setTimeout(() => {
                    toast.classList.remove('toast-show');
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            });
        });

        // Password Strength Checker
        var newPasswordInput = document.querySelector('input[name="NewPassword"]');
        if (newPasswordInput) {
            newPasswordInput.addEventListener('input', function() {
                var password = this.value;
                var strength = 0;
                var checks = {
                    length: password.length >= 8,
                    lowercase: /[a-z]/.test(password),
                    uppercase: /[A-Z]/.test(password),
                    number: /[0-9]/.test(password),
                    special: /[!@@#$%^&*(),.?":{}|<>]/.test(password)
                };

                // Update checkmarks
                updateCheckmark('req-length', checks.length);
                updateCheckmark('req-lowercase', checks.lowercase);
                updateCheckmark('req-uppercase', checks.uppercase);
                updateCheckmark('req-number', checks.number);
                updateCheckmark('req-special', checks.special);

                // Calculate strength
                for (var key in checks) {
                    if (checks[key]) strength++;
                }

                // Update strength bar
                var strengthBar = document.getElementById('strengthBar');
                var strengthText = document.getElementById('strengthText');
                var percentage = (strength / 5) * 100;
                
                strengthBar.style.width = percentage + '%';
                
                if (strength === 0) {
                    strengthBar.className = 'progress-bar';
                    strengthText.textContent = 'กรุณากรอกรหัสผ่าน';
                    strengthText.className = 'small text-muted';
                } else if (strength <= 2) {
                    strengthBar.className = 'progress-bar bg-danger';
                    strengthText.textContent = 'อ่อนแอ';
                    strengthText.className = 'small text-danger';
                } else if (strength === 3) {
                    strengthBar.className = 'progress-bar bg-warning';
                    strengthText.textContent = 'ปานกลาง';
                    strengthText.className = 'small text-warning';
                } else if (strength === 4) {
                    strengthBar.className = 'progress-bar bg-info';
                    strengthText.textContent = 'ดี';
                    strengthText.className = 'small text-info';
                } else {
                    strengthBar.className = 'progress-bar bg-success';
                    strengthText.textContent = 'แข็งแกร่ง';
                    strengthText.className = 'small text-success';
                }
            });
        }

        function updateCheckmark(id, isValid) {
            var element = document.getElementById(id);
            if (element) {
                if (isValid) {
                    element.className = 'small text-success';
                    element.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>' + element.textContent.replace(/[✓✗] /, '');
                } else {
                    element.className = 'small text-muted';
                    element.innerHTML = '<i class="bi bi-circle me-1"></i>' + element.textContent.replace(/[✓✗] /, '');
                }
            }
        }

        // Password match validation
        var confirmPasswordInput = document.querySelector('input[name="ConfirmPassword"]');
        if (confirmPasswordInput) {
            confirmPasswordInput.addEventListener('input', function() {
                var passwordInput = document.querySelector('input[name="NewPassword"]');
                var password = passwordInput ? passwordInput.value : '';
                var confirm = this.value;

                if (confirm && password !== confirm) {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            });
        }

        // Confirm change password
        function confirmChangePassword() {
            var form = document.querySelector('form');
            if (!form || !form.checkValidity()) {
                if (form) form.reportValidity();
                return;
            }

            var passwordInput = document.querySelector('input[name="NewPassword"]');
            var confirmInput = document.querySelector('input[name="ConfirmPassword"]');
            
            var password = passwordInput ? passwordInput.value : '';
            var confirm = confirmInput ? confirmInput.value : '';
            
            if (password !== confirm) {
                alert('รหัสผ่านไม่ตรงกัน');
                return;
            }

            var modal = new bootstrap.Modal(document.getElementById('confirmPasswordModal'));
            modal.show();
        }

        // Submit form
        function submitPasswordChange() {
            document.querySelector('form').submit();
        }
    </script>
}
