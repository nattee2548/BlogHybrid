@* BlogHybrid.Web/Areas/Admin/Views/Image/Test.cshtml *@
@{
    ViewData["Title"] = "ทดสอบ Image Upload";
    Layout = "_AdminLayout";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-image me-2"></i>
                        ทดสอบการอัพโหลดรูปภาพ
                    </h5>
                </div>
                <div class="admin-card-body">
                    <!-- Upload Form -->
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="imageFile" class="form-label">เลือกรูปภาพ</label>
                            <input type="file"
                                   class="form-control"
                                   id="imageFile"
                                   name="file"
                                   accept="image/*"
                                   required>
                            <div class="form-text">
                                รองรับไฟล์: .jpg, .png, .gif, .webp | ขนาดไม่เกิน 5MB
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="folderSelect" class="form-label">หมวดหมู่</label>
                            <select class="form-select" id="folderSelect" name="folder">
                                <option value="categories">Categories</option>
                                <option value="posts">Posts</option>
                                <option value="avatars">Avatars</option>
                                <option value="test">Test</option>
                            </select>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="uploadBtn">
                                <i class="fas fa-cloud-upload-alt me-2"></i>
                                อัพโหลดรูปภาพ
                            </button>
                        </div>
                    </form>

                    <!-- Progress Bar -->
                    <div class="mt-3" id="progressContainer" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Result -->
                    <div class="mt-4" id="resultContainer" style="display: none;">
                        <div class="alert alert-success" id="successResult" style="display: none;">
                            <h6><i class="fas fa-check-circle me-2"></i>อัพโหลดสำเร็จ!</h6>
                            <div id="uploadedInfo"></div>
                        </div>

                        <div class="alert alert-danger" id="errorResult" style="display: none;">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>เกิดข้อผิดพลาด</h6>
                            <div id="errorMessage"></div>
                        </div>
                    </div>

                    <!-- Image Preview -->
                    <div class="mt-4" id="imagePreview" style="display: none;">
                        <h6>ภาพตัวอย่าง:</h6>
                        <div class="text-center">
                            <img id="previewImage"
                                 src=""
                                 alt="Preview"
                                 class="img-thumbnail"
                                 style="max-width: 400px; max-height: 300px;">
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <strong>URL:</strong> <span id="imageUrl"></span>
                            </small>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-danger btn-sm" id="deleteBtn">
                                <i class="fas fa-trash me-1"></i>ลบรูปภาพ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentImagePath = null;

        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData();
            const fileInput = document.getElementById('imageFile');
            const folderSelect = document.getElementById('folderSelect');

            if (!fileInput.files[0]) {
                adminNotyf.error('กรุณาเลือกไฟล์รูปภาพ');
                return;
            }

            formData.append('file', fileInput.files[0]);
            formData.append('folder', folderSelect.value);

            // Show progress
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>กำลังอัพโหลด...';

            try {
                const response = await fetch('@Url.Action("Upload", "Image", new { area = "Admin" })', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Show success
                    document.getElementById('successResult').style.display = 'block';
                    document.getElementById('errorResult').style.display = 'none';
                    document.getElementById('resultContainer').style.display = 'block';

                    document.getElementById('uploadedInfo').innerHTML = `
                        <strong>Path:</strong> ${result.imagePath}<br>
                        <strong>URL:</strong> ${result.imageUrl}
                    `;

                    // Show image preview
                    document.getElementById('previewImage').src = result.imageUrl;
                    document.getElementById('imageUrl').textContent = result.imageUrl;
                    document.getElementById('imagePreview').style.display = 'block';

                    currentImagePath = result.imagePath;

                    adminNotyf.success(result.message);

                    // Reset form
                    document.getElementById('uploadForm').reset();
                } else {
                    // Show error
                    document.getElementById('errorResult').style.display = 'block';
                    document.getElementById('successResult').style.display = 'none';
                    document.getElementById('resultContainer').style.display = 'block';

                    document.getElementById('errorMessage').textContent = result.message;
                    adminNotyf.error(result.message);
                }
            } catch (error) {
                console.error('Upload error:', error);
                adminNotyf.error('เกิดข้อผิดพลาดในการอัพโหลด');
            } finally {
                // Hide progress
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-cloud-upload-alt me-2"></i>อัพโหลดรูปภาพ';
            }
        });

        // Delete image
        document.getElementById('deleteBtn').addEventListener('click', async function() {
            if (!currentImagePath) return;

            if (!confirm('ต้องการลบรูปภาพนี้หรือไม่?')) return;

            try {
                const response = await fetch('@Url.Action("Delete", "Image", new { area = "Admin" })', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(currentImagePath)
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('imagePreview').style.display = 'none';
                    document.getElementById('resultContainer').style.display = 'none';
                    currentImagePath = null;
                    adminNotyf.success(result.message);
                } else {
                    adminNotyf.error(result.message);
                }
            } catch (error) {
                console.error('Delete error:', error);
                adminNotyf.error('เกิดข้อผิดพลาดในการลบรูปภาพ');
            }
        });
    </script>
}

<style>
    .progress {
        height: 4px;
    }

    .admin-card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }

    #imagePreview img {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }
</style>