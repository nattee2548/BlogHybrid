@model BlogHybrid.Web.Models.ViewModels.Admin.CreateUserViewModel
@{
    ViewData["Title"] = "เพิ่มผู้ใช้ใหม่";
    Layout = "_AdminLayout";
}

<div class="admin-page-header">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1 admin-text-primary">
                <i class="fas fa-user-plus me-2"></i>เพิ่มผู้ใช้ใหม่
            </h1>
            <p class="admin-text-secondary mb-0">สร้างบัญชีผู้ใช้ใหม่และกำหนดสิทธิ์การเข้าใช้งาน</p>
        </div>
        <div class="d-flex gap-2">
            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>กลับไปรายการ
            </a>
        </div>
    </div>
</div>

<form asp-action="Create" method="post" class="admin-form" data-warn-unsaved="true" novalidate>
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Basic Information -->
            <div class="admin-card mb-4">
                <div class="admin-card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>ข้อมูลพื้นฐาน
                    </h5>
                </div>
                <div class="admin-card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Email" class="form-label required">อีเมล</label>
                                <input asp-for="Email" id="Email" class="form-control" placeholder="example@domain.com" autocomplete="email" tabindex="1">
                                <span asp-validation-for="Email" class="text-danger"></span>
                                <div class="form-text">
                                    อีเมลจะใช้เป็นชื่อผู้ใช้สำหรับเข้าสู่ระบบ <span class="text-muted small">(กด Enter เพื่อไปต่อ)</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="FirstName" class="form-label required">ชื่อ</label>
                                <input asp-for="FirstName" id="FirstName" class="form-control" placeholder="ชื่อ" autocomplete="given-name" tabindex="2">
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                                <div class="form-text">
                                    ชื่อจริงของผู้ใช้ <span class="text-muted small">(กด Enter เพื่อไปต่อ)</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="LastName" class="form-label required">นามสกุล</label>
                                <input asp-for="LastName" id="LastName" class="form-control" placeholder="นามสกุล" autocomplete="family-name" tabindex="3">
                                <span asp-validation-for="LastName" class="text-danger"></span>
                                <div class="form-text">
                                    นามสกุลของผู้ใช้ <span class="text-muted small">(กด Enter เพื่อไปต่อ)</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="PhoneNumber" class="form-label">เบอร์โทรศัพท์</label>
                                <input asp-for="PhoneNumber" id="PhoneNumber" class="form-control" placeholder="0XX-XXX-XXXX" autocomplete="tel" tabindex="4">
                                <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                                <div class="form-text">
                                    เบอร์โทรสำหรับติดต่อ (ไม่บังคับ) <span class="text-muted small">(กด Enter เพื่อไปต่อ)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Password Section -->
            <div class="admin-card mb-4">
                <div class="admin-card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-lock me-2"></i>รหัสผ่าน
                    </h5>
                </div>
                <div class="admin-card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Password" class="form-label required">รหัสผ่าน</label>
                                <div class="password-field-group">
                                    <input asp-for="Password" id="Password" type="password" class="form-control" placeholder="อย่างน้อย 6 ตัวอักษร" autocomplete="new-password" tabindex="5">
                                    <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('Password')" tabindex="-1">
                                        <i class="fas fa-eye" id="Password-icon"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="Password" class="text-danger"></span>
                                <div class="form-text">
                                    รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร <span class="text-muted small">(Enter เพื่อไปต่อ, Alt+V เพื่อแสดง/ซ่อน)</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="ConfirmPassword" class="form-label required">ยืนยันรหัสผ่าน</label>
                                <div class="password-field-group">
                                    <input asp-for="ConfirmPassword" id="ConfirmPassword" type="password" class="form-control" placeholder="ยืนยันรหัสผ่าน" autocomplete="new-password" tabindex="6">
                                    <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('ConfirmPassword')" tabindex="-1">
                                        <i class="fas fa-eye" id="ConfirmPassword-icon"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                                <div class="form-text">
                                    ป้อนรหัสผ่านอีกครั้งเพื่อยืนยัน <span class="text-muted small">(Alt+V เพื่อแสดง/ซ่อน, Enter เพื่อไปต่อ)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Settings -->
            <div class="admin-card mb-4">
                <div class="admin-card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>ตั้งค่าบัญชี
                    </h5>
                </div>
                <div class="admin-card-body">
                    <div class="mb-3">
                        <div class="form-check">
                            <input asp-for="IsActive" id="IsActive" type="checkbox" class="form-check-input" tabindex="7">
                            <label asp-for="IsActive" class="form-check-label">
                                เปิดใช้งานบัญชี
                            </label>
                        </div>
                        <div class="form-text">
                            หากปิดใช้งาน ผู้ใช้จะไม่สามารถเข้าสู่ระบบได้ <span class="text-muted small">(Space/Enter เพื่อเปลี่ยน)</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input asp-for="EmailConfirmed" id="EmailConfirmed" type="checkbox" class="form-check-input" tabindex="8">
                            <label asp-for="EmailConfirmed" class="form-check-label">
                                ยืนยันอีเมลแล้ว
                            </label>
                        </div>
                        <div class="form-text">
                            หากไม่เลือก ผู้ใช้จะต้องยืนยันอีเมลก่อนใช้งาน <span class="text-muted small">(Space/Enter เพื่อเปลี่ยน)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Role Assignment -->
            <div class="admin-card mb-4">
                <div class="admin-card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user-shield me-2"></i>บทบาทและสิทธิ์
                    </h5>
                </div>
                <div class="admin-card-body">
                    @if (Model.AvailableRoles.Any())
                    {
                        <div class="role-selection">
                            @foreach (var role in Model.AvailableRoles)
                            {
                                <div class="form-check mb-2">
                                    <input type="checkbox" name="SelectedRoles" value="@role.Value"
                                           class="form-check-input" id="role-@role.Value"
                                           @(Model.SelectedRoles?.Contains(role.Value) == true ? "checked" : "")>
                                    <label class="form-check-label" for="role-@role.Value">
                                        <span class="badge bg-@(role.Value == "Admin" ? "danger" : role.Value == "Moderator" ? "warning" : "secondary") me-2">
                                            @role.Text
                                        </span>
                                        @if (role.Value == "Admin")
                                        {
                                            <small class="text-muted d-block">สิทธิ์เต็มในระบบ รวมถึงการจัดการผู้ใช้และตั้งค่าระบบ</small>
                                        }
                                        else if (role.Value == "Moderator")
                                        {
                                            <small class="text-muted d-block">ตรวจสอบและจัดการเนื้อหา สามารถแก้ไขโพสต์และความคิดเห็น</small>
                                        }
                                        else
                                        {
                                            <small class="text-muted d-block">ผู้ใช้ทั่วไป สามารถโพสต์และแสดงความคิดเห็น</small>
                                        }
                                    </label>
                                </div>
                            }
                        </div>
                        <div class="form-text mt-2">
                            เลือกบทบาทที่เหมาะสม หากไม่เลือกจะเป็น User ทั่วไป
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            ไม่พบบทบาทที่สามารถกำหนดได้
                        </div>
                    }
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="admin-card">
                <div class="admin-card-body">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" tabindex="9">
                            <i class="fas fa-save me-2"></i>สร้างผู้ใช้
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-outline-secondary" tabindex="10">
                            <i class="fas fa-times me-2"></i>ยกเลิก
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@section Styles {
    <link rel="stylesheet" href="~/css/Admin/CreateUserForm.css" asp-append-version="true" />
}

@section Scripts {
    <!-- Form JavaScript -->
    <script src="~/js/Admin/CreateUserForm.js" asp-append-version="true"></script>

    <script>
        // Toggle password visibility (global function for onclick)
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(inputId + '-icon');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Warn about unsaved changes
        let formChanged = false;

        document.addEventListener('DOMContentLoaded', function() {
            // Track form changes
            const form = document.querySelector('form[data-warn-unsaved]');
            if (form) {
                const inputs = form.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    input.addEventListener('change', () => {
                        formChanged = true;
                    });
                    input.addEventListener('input', () => {
                        formChanged = true;
                    });
                });

                // Warn before leaving
                window.addEventListener('beforeunload', (e) => {
                    if (formChanged) {
                        e.preventDefault();
                        e.returnValue = 'คุณมีการเปลี่ยนแปลงที่ยังไม่ได้บันทึก ต้องการออกจากหน้านี้หรือไม่?';
                        return e.returnValue;
                    }
                });

                // Don't warn on form submit
                form.addEventListener('submit', () => {
                    formChanged = false;
                });
            }
        });
    </script>
}