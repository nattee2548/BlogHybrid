@model BlogHybrid.Web.Models.HomeViewModel
@{
    ViewData["Title"] = "หน้าแรก";
}

@section Styles {
    <link rel="stylesheet" href="~/css/home.css" asp-append-version="true" />
}

<div class="home-container">
    <!-- Hero Section with Featured Posts (แสดงเฉพาะหน้าแรก) -->
    @if (Model.FeaturedPosts.Any() && Model.PageNumber == 1 && !Model.HasFilters)
    {
        <section class="featured-section">
            <div class="container">
                <h2 class="featured-title">
                    <i class="bi bi-star-fill"></i> โพสต์แนะนำ
                </h2>
                <div class="featured-grid">
                    @foreach (var post in Model.FeaturedPosts)
                    {
                        <a href="@Url.Action("Details", "Post", new { slug = post.Slug })" class="featured-card">
                            @if (!string.IsNullOrEmpty(post.FeaturedImageUrl))
                            {
                                <div class="featured-image">
                                    <img src="@post.FeaturedImageUrl" alt="@post.Title" />
                                    <div class="featured-badge">
                                        <i class="bi bi-star-fill"></i> แนะนำ
                                    </div>
                                </div>
                            }
                            <div class="featured-content">
                                <h3 class="featured-post-title">@post.Title</h3>
                                @if (!string.IsNullOrEmpty(post.Excerpt))
                                {
                                    <p class="featured-excerpt">@post.Excerpt</p>
                                }
                                <div class="featured-meta">
                                    <span class="meta-author">
                                        @if (!string.IsNullOrEmpty(post.AuthorProfileImageUrl))
                                        {
                                            <img src="@post.AuthorProfileImageUrl" alt="@post.AuthorName" class="author-avatar-sm" />
                                        }
                                        else
                                        {
                                            <div class="author-avatar-sm">
                                                <i class="bi bi-person-fill"></i>
                                            </div>
                                        }
                                        @post.AuthorName
                                    </span>
                                    <span class="meta-date">@post.TimeAgo</span>
                                    <span class="meta-views">
                                        <i class="bi bi-eye"></i> @post.ViewCount
                                    </span>
                                </div>
                            </div>
                        </a>
                    }
                </div>
            </div>
        </section>
    }

    <!-- Main Content -->
    <div class="container">
        <div class="main-content-grid">
            <!-- Sidebar Filters (Left) -->
            <aside class="sidebar-filters">
                <div class="filter-card">
                    <h3 class="filter-title">
                        <i class="bi bi-funnel"></i> กรองโพสต์
                    </h3>

                    <!-- Search -->
                    <form asp-action="Index" method="get" class="filter-search">
                        <div class="search-input-group">
                            <i class="bi bi-search"></i>
                            <input type="text" 
                                   name="search" 
                                   value="@Model.SearchTerm" 
                                   placeholder="ค้นหาโพสต์..." 
                                   class="search-input" />
                            @if (!string.IsNullOrEmpty(Model.SearchTerm))
                            {
                                <button type="button" onclick="clearSearch()" class="search-clear">
                                    <i class="bi bi-x"></i>
                                </button>
                            }
                        </div>
                        <input type="hidden" name="categoryId" value="@Model.CategoryId" />
                        <input type="hidden" name="communityId" value="@Model.CommunityId" />
                        <input type="hidden" name="sort" value="@Model.Sort" />
                        <button type="submit" class="btn-search">ค้นหา</button>
                    </form>

                    <!-- Sort Options -->
                    <div class="filter-section">
                        <label class="filter-label">เรียงตาม</label>
                        <div class="filter-options">
                            <a href="@Url.Action("Index", new { search = Model.SearchTerm, categoryId = Model.CategoryId, sort = "latest" })" 
                               class="filter-option @(Model.Sort == "latest" ? "active" : "")">
                                <i class="bi bi-clock"></i> ล่าสุด
                            </a>
                            <a href="@Url.Action("Index", new { search = Model.SearchTerm, categoryId = Model.CategoryId, sort = "popular" })" 
                               class="filter-option @(Model.Sort == "popular" ? "active" : "")">
                                <i class="bi bi-fire"></i> ยอดนิยม
                            </a>
                            <a href="@Url.Action("Index", new { search = Model.SearchTerm, categoryId = Model.CategoryId, sort = "liked" })" 
                               class="filter-option @(Model.Sort == "liked" ? "active" : "")">
                                <i class="bi bi-heart-fill"></i> ถูกใจมากสุด
                            </a>
                        </div>
                    </div>

                    <!-- Clear Filters -->
                    @if (Model.HasFilters)
                    {
                        <a href="@Url.Action("Index")" class="btn-clear-filters">
                            <i class="bi bi-x-circle"></i> ล้างตัวกรอง
                        </a>
                    }
                </div>
            </aside>

            <!-- Posts Grid (Right) -->
            <main class="posts-section">
                <!-- Header -->
                <div class="posts-header">
                    <h1 class="posts-title">
                        @if (Model.HasFilters)
                        {
                            <text>ผลการค้นหา</text>
                        }
                        else
                        {
                            <text>โพสต์ทั้งหมด</text>
                        }
                    </h1>
                    <p class="posts-count">พบ @Model.TotalCount โพสต์</p>
                </div>

                <!-- Posts Grid -->
                @if (Model.Posts.Any())
                {
                    <div class="posts-grid">
                        @foreach (var post in Model.Posts)
                        {
                            <article class="post-card">
                                <!-- Featured Image -->
                                @if (!string.IsNullOrEmpty(post.FeaturedImageUrl))
                                {
                                    <a href="@Url.Action("Details", "Post", new { slug = post.Slug })" class="post-image-link">
                                        <img src="@post.FeaturedImageUrl" alt="@post.Title" class="post-image" />
                                    </a>
                                }
                                else
                                {
                                    <a href="@Url.Action("Details", "Post", new { slug = post.Slug })" class="post-image-link post-image-placeholder">
                                        <i class="bi bi-image"></i>
                                    </a>
                                }

                                <!-- Content -->
                                <div class="post-content">
                                    <!-- Category Badge -->
                                    @if (!string.IsNullOrEmpty(post.CategoryName))
                                    {
                                        <a href="@Url.Action("Index", new { categoryId = post.CategoryId })" 
                                           class="post-category" 
                                           style="background: @(post.CategoryColor)20; color: @post.CategoryColor;">
                                            <i class="bi bi-folder"></i> @post.CategoryName
                                        </a>
                                    }

                                    <!-- Title -->
                                    <h3 class="post-title">
                                        <a href="@Url.Action("Details", "Post", new { slug = post.Slug })">
                                            @post.Title
                                        </a>
                                    </h3>

                                    <!-- Excerpt -->
                                    @if (!string.IsNullOrEmpty(post.Excerpt))
                                    {
                                        <p class="post-excerpt">@post.Excerpt</p>
                                    }

                                    <!-- Tags -->
                                    @if (post.Tags.Any())
                                    {
                                        <div class="post-tags">
                                            @foreach (var tag in post.Tags.Take(3))
                                            {
                                                <a href="@Url.Action("Index", new { tag = tag })" class="post-tag">
                                                    #@tag
                                                </a>
                                            }
                                            @if (post.Tags.Count > 3)
                                            {
                                                <span class="post-tag-more">+@(post.Tags.Count - 3)</span>
                                            }
                                        </div>
                                    }

                                    <!-- Footer Meta -->
                                    <div class="post-footer">
                                        <div class="post-author">
                                            @if (!string.IsNullOrEmpty(post.AuthorProfileImageUrl))
                                            {
                                                <img src="@post.AuthorProfileImageUrl" alt="@post.AuthorName" class="author-avatar" />
                                            }
                                            else
                                            {
                                                <div class="author-avatar">
                                                    <i class="bi bi-person-fill"></i>
                                                </div>
                                            }
                                            <span class="author-name">@post.AuthorName</span>
                                        </div>
                                        <div class="post-stats">
                                            <span class="stat-item">
                                                <i class="bi bi-eye"></i> @post.ViewCount
                                            </span>
                                            <span class="stat-item">
                                                <i class="bi bi-heart"></i> @post.LikeCount
                                            </span>
                                            <span class="stat-item">
                                                <i class="bi bi-chat"></i> @post.CommentCount
                                            </span>
                                        </div>
                                        <span class="post-date">@post.TimeAgo</span>
                                    </div>
                                </div>
                            </article>
                        }
                    </div>

                    <!-- Pagination -->
                    @if (Model.TotalPages > 1)
                    {
                        <nav class="pagination-nav">
                            <ul class="pagination">
                                @if (Model.HasPreviousPage)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@Url.Action("Index", new { 
                                            page = Model.PageNumber - 1, 
                                            search = Model.SearchTerm,
                                            categoryId = Model.CategoryId,
                                            sort = Model.Sort 
                                        })">
                                            <i class="bi bi-chevron-left"></i> ก่อนหน้า
                                        </a>
                                    </li>
                                }

                                @for (int i = 1; i <= Model.TotalPages; i++)
                                {
                                    if (i == 1 || i == Model.TotalPages || (i >= Model.PageNumber - 2 && i <= Model.PageNumber + 2))
                                    {
                                        <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                            <a class="page-link" href="@Url.Action("Index", new { 
                                                page = i, 
                                                search = Model.SearchTerm,
                                                categoryId = Model.CategoryId,
                                                sort = Model.Sort 
                                            })">@i</a>
                                        </li>
                                    }
                                    else if (i == Model.PageNumber - 3 || i == Model.PageNumber + 3)
                                    {
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    }
                                }

                                @if (Model.HasNextPage)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@Url.Action("Index", new { 
                                            page = Model.PageNumber + 1, 
                                            search = Model.SearchTerm,
                                            categoryId = Model.CategoryId,
                                            sort = Model.Sort 
                                        })">
                                            ถัดไป <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </nav>
                    }
                }
                else
                {
                    <!-- No Results -->
                    <div class="no-results">
                        <i class="bi bi-inbox"></i>
                        <h3>ไม่พบโพสต์</h3>
                        <p>ลองค้นหาด้วยคำค้นอื่นหรือล้างตัวกรอง</p>
                        @if (Model.HasFilters)
                        {
                            <a href="@Url.Action("Index")" class="btn btn-primary">
                                <i class="bi bi-arrow-left"></i> กลับหน้าแรก
                            </a>
                        }
                    </div>
                }
            </main>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function clearSearch() {
            document.querySelector('input[name="search"]').value = '';
            document.querySelector('.filter-search').submit();
        }
    </script>
}
